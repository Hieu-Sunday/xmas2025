<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Magic Christmas - Final</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>

    <style>
        body { margin: 0; overflow: hidden; background-color: #000; font-family: 'Segoe UI', sans-serif; }
        #canvas-container { width: 100%; height: 100vh; display: block; }
        #ui-layer { position: absolute; bottom: 30px; width: 100%; text-align: center; z-index: 100; pointer-events: none; }
        .guide { color: rgba(255, 255, 255, 0.7); font-size: 14px; margin-bottom: 20px; text-shadow: 0 2px 4px #000; }
        button { 
            pointer-events: auto; cursor: pointer; padding: 15px 40px; border-radius: 30px;
            background: linear-gradient(#D32F2F, #8B0000); color: #FFF; border: 2px solid #FFD700;
            font-weight: bold; box-shadow: 0 0 20px rgba(255,0,0,0.5); animation: pulse 1.5s infinite;
        }
        @keyframes pulse { 0% {transform: scale(1)} 50% {transform: scale(1.05)} 100% {transform: scale(1)} }
        #camera-preview { position: absolute; top: 15px; right: 15px; width: 120px; height: 90px; border: 2px solid #ff000088; transform: scaleX(-1); border-radius: 8px; }
        #copyright { position: absolute; bottom: 10px; right: 15px; color: #ffffff44; font-size: 12px; font-style: italic; }
    </style>
</head>
<body>

    <div id="ui-layer">
        <div class="guide">üñê M·ªü tay: N·ªï hoa | ‚úä N·∫Øm tay: C√¢y th√¥ng | ü´∂ 2 tay: Tr√°i tim</div>
        <button id="btnStart" onclick="startSystem()">START MAGIC</button>
    </div>

    <div id="copyright">¬© by vandiep</div>
    
    <div id="canvas-container"></div>
    
    <video class="input_video" style="display:none"></video>
    <canvas id="camera-preview"></canvas>

    <script>
        const MUSIC_URL = "./xmasMusic.mp3";
        let bgMusic = new Audio(MUSIC_URL);
        bgMusic.loop = true;

        const loader = new THREE.TextureLoader();
        const photoFiles = ['./NL1.jpg', './NL2.jpg', './NL3.jpg', './NL4.jpg', './NL5.jpg', './NL6.jpg', './NL7.jpg', './NL8.jpg', './NL9.jpg', './NL10.jpg'];
        const photoTextures = photoFiles.map(f => loader.load(f));

        const textures = {
            gold: createCustomTexture('gold_glow'),
            red: createCustomTexture('red_light'),
            gift: createCustomTexture('gift_red')
        };

        const CONFIG = { goldCount: 2000, redCount: 300, giftCount: 150, explodeRadius: 65, photoOrbitRadius: 25, treeHeight: 70, treeBaseRadius: 35 };
        let scene, camera, renderer, groupGold, groupRed, groupGift, photoMeshes = [], titleMesh, starMesh, loveMesh;
        let state = 'TREE', selectedIndex = 0, handX = 0.5, isInitialized = false;

        function createCustomTexture(type) {
            const canvas = document.createElement('canvas'); canvas.width = 128; canvas.height = 128;
            const ctx = canvas.getContext('2d');
            if (type === 'gold_glow') {
                const g = ctx.createRadialGradient(64,64,0,64,64,40);
                g.addColorStop(0,'#FFF'); g.addColorStop(0.5,'#FFD700'); g.addColorStop(1,'transparent');
                ctx.fillStyle = g; ctx.fillRect(0,0,128,128);
            } else if (type === 'gift_red') {
                ctx.fillStyle = '#D32F2F'; ctx.fillRect(20,20,88,88);
                ctx.fillStyle = '#FFD700'; ctx.fillRect(54,20,20,88); ctx.fillRect(20,54,88,20);
            } else {
                const g = ctx.createRadialGradient(64,64,0,64,64,50);
                g.addColorStop(0,'#FFAAAA'); g.addColorStop(0.3,'#FF0000'); g.addColorStop(1,'transparent');
                ctx.fillStyle = g; ctx.fillRect(0,0,128,128);
            }
            return new THREE.CanvasTexture(canvas);
        }

        function init3D() {
            if(isInitialized) return;
            const container = document.getElementById('canvas-container');
            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(60, window.innerWidth/window.innerHeight, 0.1, 1000);
            camera.position.z = 100;

            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            container.appendChild(renderer.domElement);

            groupGold = createParticles('gold', CONFIG.goldCount, 2.0);
            groupRed = createParticles('red', CONFIG.redCount, 3.5);
            groupGift = createParticles('gift', CONFIG.giftCount, 3.0);

            createPhotos();
            createDecorations();
            isInitialized = true;
            animate();
        }

        function createParticles(type, count, size) {
            const pos = [], exp = [], tree = [], heart = [], phases = [];
            for(let i=0; i<count; i++) {
                // Tree
                const h = Math.random() * CONFIG.treeHeight;
                const r = (1 - (h/CONFIG.treeHeight)) * CONFIG.treeBaseRadius * (type==='gold'?Math.sqrt(Math.random()):1);
                const t = Math.random() * Math.PI * 2;
                tree.push(r*Math.cos(t), h - CONFIG.treeHeight/2, r*Math.sin(t));
                // Explode
                const phi = Math.acos(2*Math.random()-1), lam = 2*Math.PI*Math.random();
                const rad = CONFIG.explodeRadius * Math.cbrt(Math.random());
                exp.push(rad*Math.sin(phi)*Math.cos(lam), rad*Math.sin(phi)*Math.sin(lam), rad*Math.cos(phi));
                // Heart
                const th = Math.random()*Math.PI*2;
                let hx = 16*Math.pow(Math.sin(th),3), hy = 13*Math.cos(th)-5*Math.cos(2*th)-2*Math.cos(3*th)-Math.cos(4*th);
                const rf = Math.pow(Math.random(),0.3);
                heart.push(hx*rf*2.2, hy*rf*2.2+5, (Math.random()-0.5)*8);
                pos.push(tree[i*3], tree[i*3+1], tree[i*3+2]);
                phases.push(Math.random()*Math.PI*2);
            }
            const geo = new THREE.BufferGeometry();
            geo.setAttribute('position', new THREE.Float32BufferAttribute(pos, 3));
            geo.userData = { tree, explode: exp, heart, phases, baseSize: size };
            const mat = new THREE.PointsMaterial({ size, map: textures[type], transparent: true, blending: THREE.AdditiveBlending, depthWrite: false });
            const p = new THREE.Points(geo, mat); scene.add(p); return p;
        }

        function createPhotos() {
            const geo = new THREE.PlaneGeometry(8, 8);
            photoTextures.forEach(tex => {
                const mesh = new THREE.Mesh(geo, new THREE.MeshBasicMaterial({ map: tex, side: THREE.DoubleSide }));
                mesh.visible = false; scene.add(mesh); photoMeshes.push(mesh);
            });
        }

        function createDecorations() {
            const canvas = document.createElement('canvas'); canvas.width = 512; canvas.height = 128;
            const ctx = canvas.getContext('2d'); ctx.font = 'bold 40px Arial'; ctx.fillStyle = '#FFD700'; ctx.textAlign='center';
            ctx.fillText("MERRY CHRISTMAS", 256, 80);
            titleMesh = new THREE.Mesh(new THREE.PlaneGeometry(50, 12), new THREE.MeshBasicMaterial({ map: new THREE.CanvasTexture(canvas), transparent: true }));
            titleMesh.position.y = 45; scene.add(titleMesh);
        }

        function animate() {
            requestAnimationFrame(animate);
            const time = Date.now() * 0.001;
            [groupGold, groupRed, groupGift].forEach(g => {
                const target = state === 'TREE' ? g.userData.tree : (state === 'HEART' ? g.userData.heart : g.userData.explode);
                const pos = g.geometry.attributes.position.array;
                for(let i=0; i<pos.length; i++) pos[i] += (target[i] - pos[i]) * 0.08;
                g.geometry.attributes.position.needsUpdate = true;
                if(state === 'TREE') g.rotation.y += 0.005;
            });

            if(state === 'EXPLODE') {
                photoMeshes.forEach((m, i) => {
                    m.visible = true;
                    const ang = groupGold.rotation.y + i * (Math.PI*2/10);
                    m.position.set(Math.sin(ang)*25, Math.sin(time+i)*3, Math.cos(ang)*25);
                    m.lookAt(camera.position);
                });
            } else {
                photoMeshes.forEach(m => m.visible = false);
            }
            renderer.render(scene, camera);
        }

        function startSystem() {
            document.getElementById('btnStart').style.display = 'none';
            bgMusic.play().catch(() => {});
            init3D();
            const video = document.querySelector('.input_video');
            const hands = new Hands({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`});
            hands.setOptions({ maxNumHands: 2, modelComplexity: 1, minDetectionConfidence: 0.5 });
            hands.onResults(results => {
                const canv = document.getElementById('camera-preview');
                const ctx = canv.getContext('2d');
                ctx.clearRect(0,0,canv.width,canv.height);
                ctx.drawImage(results.image, 0,0, canv.width, canv.height);
                if(results.multiHandLandmarks.length === 2) state = 'HEART';
                else if(results.multiHandLandmarks.length === 1) {
                    const lm = results.multiHandLandmarks[0];
                    const dist = Math.hypot(lm[8].x - lm[0].x, lm[8].y - lm[0].y);
                    state = dist < 0.2 ? 'TREE' : 'EXPLODE';
                } else state = 'TREE';
            });
            const cam = new Camera(video, { onFrame: async () => { await hands.send({image: video}); }, width: 320, height: 240 });
            cam.start();
        }

        window.addEventListener('resize', () => {
            if(!camera) return;
            camera.aspect = window.innerWidth/window.innerHeight; camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });
    </script>
</body>
</html>
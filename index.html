<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Magic Christmas 2025</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
    <style>
        body { margin: 0; overflow: hidden; background: #000; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        #canvas-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; }
        #ui-layer { position: absolute; bottom: 40px; width: 100%; text-align: center; z-index: 10; }
        #btnStart { 
            padding: 15px 40px; font-size: 20px; cursor: pointer; border-radius: 50px; 
            background: linear-gradient(45deg, #ff0000, #d40000); color: white; 
            border: 2px solid #ffd700; box-shadow: 0 0 20px rgba(255,0,0,0.5);
            transition: 0.3s;
        }
        #btnStart:hover { transform: scale(1.1); background: #ff4444; }
        #camera-preview { position: absolute; top: 20px; right: 20px; width: 160px; height: 120px; border: 2px solid #333; border-radius: 10px; transform: scaleX(-1); z-index: 5; background: #111; }
        .hint { color: #ffd700; margin-top: 15px; text-shadow: 2px 2px 4px #000; font-weight: bold; }
    </style>
</head>
<body>

<div id="canvas-container"></div>
<canvas id="camera-preview"></canvas>
<video class="input_video" style="display:none"></video>

<div id="ui-layer">
    <button id="btnStart">START MAGIC üéÑ</button>
    <div class="hint">üñê M·ªü tay: Ph√°o hoa | ‚úä N·∫Øm tay: Hi·ªán C√¢y th√¥ng | ü´∂ 2 tay: Tr√°i tim ·∫£nh</div>
</div>

<script>
let scene, camera, renderer, treeGroup, photoGroup;
let isStarted = false;
const textureLoader = new THREE.TextureLoader();

// Danh s√°ch 10 ·∫£nh c·ªßa b·∫°n
const photoFiles = ['NL1.jpg', 'NL2.jpg', 'NL3.jpg', 'NL4.jpg', 'NL5.jpg', 'NL6.jpg', 'NL7.jpg', 'NL8.jpg', 'NL9.jpg', 'NL10.jpg'];
const bgMusic = new Audio('xmasMusic.mp3'); 

function init3D() {
    scene = new THREE.Scene();
    camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
    camera.position.z = 120;

    renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    document.getElementById('canvas-container').appendChild(renderer.domElement);

    // 1. T·∫°o hi·ªáu ·ª©ng C√¢y th√¥ng t·ª´ c√°c h·∫°t s√°ng (Fist Action)
    treeGroup = new THREE.Group();
    const treeGeo = new THREE.BufferGeometry();
    const treePoints = [];
    for(let i=0; i<4000; i++) {
        let h = Math.random() * 80;
        let r = (1 - h/80) * 40 * Math.sqrt(Math.random());
        let angle = Math.random() * Math.PI * 2;
        treePoints.push(r * Math.cos(angle), h - 40, r * Math.sin(angle));
    }
    treeGeo.setAttribute('position', new THREE.Float32BufferAttribute(treePoints, 3));
    const treeMat = new THREE.PointsMaterial({ color: 0x00ff88, size: 0.6 });
    treeGroup.add(new THREE.Points(treeGeo, treeMat));
    scene.add(treeGroup);
    treeGroup.visible = false;

    // 2. T·∫°o v√≤ng xo√°y ·∫£nh t·ª´ 10 file NL*.jpg (Heart Action)
    photoGroup = new THREE.Group();
    photoFiles.forEach((file, i) => {
        textureLoader.load(file, (tex) => {
            const mat = new THREE.MeshBasicMaterial({ map: tex, side: THREE.DoubleSide });
            const geo = new THREE.PlaneGeometry(15, 20);
            const mesh = new THREE.Mesh(geo, mat);
            const angle = (i / photoFiles.length) * Math.PI * 2;
            mesh.position.set(Math.cos(angle) * 50, Math.sin(angle) * 30, 0);
            photoGroup.add(mesh);
        });
    });
    scene.add(photoGroup);
    photoGroup.visible = false;

    // √Ånh s√°ng
    scene.add(new THREE.AmbientLight(0xffffff, 1));
    
    animate();
}

function animate() {
    requestAnimationFrame(animate);
    if(treeGroup.visible) treeGroup.rotation.y += 0.02;
    if(photoGroup.visible) photoGroup.rotation.y -= 0.01;
    renderer.render(scene, camera);
}

// X·ª≠ l√Ω nh·∫≠n di·ªán c·ª≠ ch·ªâ tay
async function onResults(results) {
    const canvasCtx = document.getElementById('camera-preview').getContext('2d');
    canvasCtx.save();
    canvasCtx.clearRect(0, 0, 160, 120);
    canvasCtx.drawImage(results.image, 0, 0, 160, 120);
    canvasCtx.restore();

    if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
        const hand = results.multiHandLandmarks[0];
        // T√≠nh kho·∫£ng c√°ch ng√≥n tr·ªè v√† ng√≥n c√°i ƒë·ªÉ ƒëo√°n n·∫Øm/m·ªü
        const dist = Math.hypot(hand[8].x - hand[4].x, hand[8].y - hand[4].y);
        
        if(dist < 0.1) { // N·∫Øm tay (Fist)
            treeGroup.visible = true;
            photoGroup.visible = false;
        } else { // M·ªü tay (Open)
            treeGroup.visible = false;
            photoGroup.visible = true;
        }
    }
}

document.getElementById('btnStart').onclick = () => {
    isStarted = true;
    document.getElementById('ui-layer').style.display = 'none';
    bgMusic.play().catch(e => console.log("Ch∆∞a c√≥ file nh·∫°c ho·∫∑c l·ªói!"));
    
    init3D();

    const videoElement = document.querySelector('.input_video');
    const hands = new Hands({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`});
    hands.setOptions({ maxNumHands: 2, modelComplexity: 1, minDetectionConfidence: 0.5 });
    hands.onResults(onResults);

    const cameraUtils = new Camera(videoElement, {
        onFrame: async () => { await hands.send({image: videoElement}); },
        width: 640, height: 480
    });
    cameraUtils.start();
};
</script>
</body>
</html>
<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Gi√°ng Sinh An L√†nh - Magic AR</title>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <style>
        body { margin: 0; overflow: hidden; background: #000; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        #video-container { position: relative; width: 100vw; height: 100vh; }
        canvas { position: absolute; top: 0; left: 0; z-index: 5; }
        #ui { position: absolute; bottom: 30px; width: 100%; text-align: center; z-index: 10; color: #fff; text-shadow: 2px 2px 4px #000; }
        #start-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 100; }
        button { padding: 15px 40px; font-size: 20px; background: #d32f2f; color: white; border: 2px solid #ffca28; border-radius: 50px; cursor: pointer; transition: 0.3s; box-shadow: 0 0 20px rgba(211,47,47,0.6); }
        button:hover { transform: scale(1.1); background: #ffca28; color: #d32f2f; }
        .guide { margin-top: 15px; font-size: 14px; color: #ffca28; }
    </style>
</head>
<body>

    <div id="start-screen">
        <button id="btn-start">üéÑ KH√ÅM PH√Å PH√âP M√ÄU üéÑ</button>
        <div class="guide">Vui l√≤ng cho ph√©p truy c·∫≠p Camera sau khi b·∫•m</div>
    </div>

    <div id="ui">
        <div>üñêÔ∏è M·ªü tay: N·ªï hoa & ·∫¢nh | ‚úä N·∫Øm tay: C√¢y th√¥ng | ü´∂ 2 tay: Tr√°i tim</div>
        <div style="font-size: 12px; margin-top: 5px; opacity: 0.7;">¬© 2025 Magic Christmas</div>
    </div>

    <video id="input_video" style="display:none"></video>
    <div id="video-container"></div>

    <script>
        const music = new Audio('xmasMusic.mp3');
        music.loop = true;

        let scene, camera, renderer, snowParticles, tree, heartParticles, photoGroup;
        let videoElement, hands;

        function init() {
            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.z = 100;

            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            document.getElementById('video-container').appendChild(renderer.domElement);

            // 1. T·∫°o Tuy·∫øt r∆°i
            const snowGeo = new THREE.BufferGeometry();
            const snowCoords = [];
            for (let i = 0; i < 1500; i++) {
                snowCoords.push((Math.random() - 0.5) * 300, Math.random() * 300, (Math.random() - 0.5) * 300);
            }
            snowGeo.setAttribute('position', new THREE.Float32BufferAttribute(snowCoords, 3));
            const snowMat = new THREE.PointsMaterial({ color: 0xffffff, size: 1.5, transparent: true });
            snowParticles = new THREE.Points(snowGeo, snowMat);
            scene.add(snowParticles);

            // 2. T·∫°o C√¢y th√¥ng (Wireframe)
            const treeGeo = new THREE.ConeGeometry(25, 60, 8);
            const treeMat = new THREE.MeshBasicMaterial({ color: 0x2e7d32, wireframe: true });
            tree = new THREE.Mesh(treeGeo, treeMat);
            scene.add(tree);
            tree.visible = false;

            // 3. Nh√≥m 10 ·∫£nh NL
            photoGroup = new THREE.Group();
            const loader = new THREE.TextureLoader();
            for(let i=1; i<=10; i++) {
                loader.load(`NL${i}.jpg`, (tex) => {
                    const p = new THREE.Mesh(new THREE.PlaneGeometry(20, 28), new THREE.MeshBasicMaterial({map: tex, side: 2}));
                    const ang = (i/10) * Math.PI * 2;
                    p.position.set(Math.cos(ang)*60, Math.sin(ang)*20, Math.sin(ang)*30);
                    p.lookAt(0,0,0);
                    photoGroup.add(p);
                });
            }
            scene.add(photoGroup);
            photoGroup.visible = false;

            animate();
        }

        function animate() {
            requestAnimationFrame(animate);
            if(snowParticles) {
                snowParticles.rotation.y += 0.002;
                snowParticles.position.y -= 0.2;
                if(snowParticles.position.y < -150) snowParticles.position.y = 0;
            }
            if(tree.visible) tree.rotation.y += 0.05;
            if(photoGroup.visible) photoGroup.rotation.y += 0.02;
            renderer.render(scene, camera);
        }

        // X·ª≠ l√Ω AI nh·∫≠n di·ªán tay
        function onResults(results) {
            if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
                const landmarks = results.multiHandLandmarks[0];
                const thumbTip = landmarks[4];
                const indexTip = landmarks[8];
                const dist = Math.hypot(thumbTip.x - indexTip.x, thumbTip.y - indexTip.y);

                if (results.multiHandLandmarks.length === 2) {
                    // Hi·ªáu ·ª©ng 2 tay (n·∫øu c·∫ßn l√†m tim, t·∫°m th·ªùi ·∫©n h·∫øt hi·ªán n·ªÅn ƒë·∫πp)
                    tree.visible = false; photoGroup.visible = false;
                } else {
                    if (dist < 0.08) { // N·∫Øm tay
                        tree.visible = true; photoGroup.visible = false;
                    } else { // M·ªü tay
                        tree.visible = false; photoGroup.visible = true;
                    }
                }
            } else {
                tree.visible = false; photoGroup.visible = false;
            }
        }

        document.getElementById('btn-start').onclick = async () => {
            document.getElementById('start-screen').style.display = 'none';
            music.play();
            init();

            videoElement = document.getElementById('input_video');
            hands = new Hands({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`});
            hands.setOptions({ maxNumHands: 2, modelComplexity: 1, minDetectionConfidence: 0.6 });
            hands.onResults(onResults);

            const cam = new Camera(videoElement, {
                onFrame: async () => { await hands.send({image: videoElement}); },
                width: 1280, height: 720
            });
            cam.start();
            
            // ƒê∆∞a video webcam l√†m n·ªÅn
            const videoCanvas = document.createElement('canvas');
            videoCanvas.style.position = 'fixed';
            videoCanvas.style.top = '0'; videoCanvas.style.left = '0';
            videoCanvas.style.width = '100vw'; videoCanvas.style.height = '100vh';
            videoCanvas.style.objectFit = 'cover';
            videoCanvas.style.transform = 'scaleX(-1)';
            videoCanvas.style.zIndex = '1';
            document.body.appendChild(videoCanvas);
            
            const ctx = videoCanvas.getContext('2d');
            function drawVideo() {
                ctx.drawImage(videoElement, 0, 0, videoCanvas.width, videoCanvas.height);
                requestAnimationFrame(drawVideo);
            }
            drawVideo();
        };

        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });
    </script>
</body>
</html>
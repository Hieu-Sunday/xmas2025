<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Magic Christmas 2025 - NL Edition</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>

    <style>
        body { margin: 0; overflow: hidden; background-color: #000; font-family: 'Segoe UI', sans-serif; }
        #canvas-container { width: 100vw; height: 100vh; display: block; }
        
        #ui-layer {
            position: absolute; bottom: 30px; width: 100%;
            text-align: center; z-index: 100;
        }
        
        .guide { 
            color: #FFD700; font-size: 14px; margin-bottom: 20px; 
            text-shadow: 0 2px 4px rgba(0,0,0,0.8); font-weight: bold;
        }

        button {
            cursor: pointer; background: linear-gradient(to bottom, #D32F2F, #8B0000); 
            color: #FFF; border: 2px solid #FFD700;
            padding: 15px 50px; border-radius: 30px; 
            font-weight: 800; font-size: 18px;
            box-shadow: 0 0 20px rgba(255, 0, 0, 0.6);
            transition: 0.3s;
        }
        button:hover { transform: scale(1.1); box-shadow: 0 0 30px #ff0000; }

        #camera-preview {
            position: absolute; top: 15px; right: 15px;
            width: 140px; height: 105px;
            border: 2px solid #FFD700; 
            transform: scaleX(-1); border-radius: 8px; z-index: 50;
            background: #111;
        }

        #copyright {
            position: absolute; bottom: 10px; right: 15px;
            color: rgba(255, 255, 255, 0.4); font-size: 11px; z-index: 100;
        }
    </style>
</head>
<body>

    <div id="ui-layer">
        <div class="guide">üñê M·ªü: ·∫¢nh Xoay | ‚úä N·∫Øm: C√¢y Th√¥ng | ü´∂ 2 Tay: Tr√°i Tim</div>
        <button id="btnStart" onclick="startSystem()">START MAGIC üéÑ</button>
    </div>

    <div id="copyright">¬© 2025 Magic Xmas</div>

    <div id="canvas-container"></div>
    
    <video class="input_video" style="display:none"></video>
    <canvas id="camera-preview"></canvas>

    <script>
        // 1. C·∫•u h√¨nh file c·ªßa b·∫°n
        const MUSIC_URL = "xmasMusic.mp3"; 
        const photoFiles = [];
        for(let i=1; i<=10; i++) { photoFiles.push(`NL${i}.jpg`); }

        let scene, camera, renderer, bgMusic;
        let treeGroup, photoGroup, starMesh;
        let currentState = 'NONE';

        // Kh·ªüi t·∫°o √¢m thanh
        bgMusic = new Audio(MUSIC_URL);
        bgMusic.loop = true;

        function init3D() {
            const container = document.getElementById('canvas-container');
            scene = new THREE.Scene();
            
            camera = new THREE.PerspectiveCamera(60, window.innerWidth/window.innerHeight, 0.1, 1000);
            camera.position.z = 100;

            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            container.appendChild(renderer.domElement);

            // T·∫°o Nh√≥m C√¢y Th√¥ng (Fist)
            treeGroup = new THREE.Group();
            const points = [];
            for (let i = 0; i < 3000; i++) {
                const h = Math.random() * 70;
                const r = (1 - h / 70) * 35 * Math.sqrt(Math.random());
                const t = Math.random() * Math.PI * 2;
                points.push(r * Math.cos(t), h - 35, r * Math.sin(t));
            }
            const treeGeo = new THREE.BufferGeometry();
            treeGeo.setAttribute('position', new THREE.Float32BufferAttribute(points, 3));
            const treeMat = new THREE.PointsMaterial({ color: 0x22ff33, size: 0.7 });
            treeGroup.add(new THREE.Points(treeGeo, treeMat));
            scene.add(treeGroup);
            treeGroup.visible = false;

            // T·∫°o Nh√≥m 10 ·∫£nh NL (Open Hand)
            photoGroup = new THREE.Group();
            const loader = new THREE.TextureLoader();
            photoFiles.forEach((file, i) => {
                loader.load(file, (texture) => {
                    const mesh = new THREE.Mesh(
                        new THREE.PlaneGeometry(15, 20),
                        new THREE.MeshBasicMaterial({ map: texture, side: THREE.DoubleSide })
                    );
                    const angle = (i / photoFiles.length) * Math.PI * 2;
                    mesh.position.set(Math.cos(angle) * 45, Math.sin(angle) * 10, Math.sin(angle) * 20);
                    mesh.lookAt(0, 0, 0);
                    photoGroup.add(mesh);
                }, undefined, (err) => console.log("L·ªói load ·∫£nh: " + file));
            });
            scene.add(photoGroup);
            photoGroup.visible = false;

            animate();
        }

        function animate() {
            requestAnimationFrame(animate);
            if(treeGroup.visible) treeGroup.rotation.y += 0.02;
            if(photoGroup.visible) photoGroup.rotation.y += 0.01;
            renderer.render(scene, camera);
        }

        async function startSystem() {
            document.getElementById('btnStart').style.display = 'none';
            bgMusic.play().catch(e => alert("H√£y ki·ªÉm tra file xmasMusic.mp3!"));
            
            init3D();

            const video = document.querySelector('.input_video');
            const hands = new Hands({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`});
            
            hands.setOptions({ maxNumHands: 2, modelComplexity: 1, minDetectionConfidence: 0.6 });
            
            hands.onResults(results => {
                // V·∫Ω cam nh·ªè g√≥c m√†n h√¨nh
                const cv = document.getElementById('camera-preview');
                const ctx = cv.getContext('2d');
                ctx.clearRect(0,0,cv.width, cv.height);
                ctx.drawImage(results.image, 0, 0, cv.width, cv.height);

                if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
                    const lm = results.multiHandLandmarks[0];
                    // Logic nh·∫≠n di·ªán N·∫Øm/M·ªü
                    const dist = Math.hypot(lm[8].x - lm[4].x, lm[8].y - lm[4].y);
                    
                    if (dist < 0.1) { // N·∫Øm tay
                        treeGroup.visible = true;
                        photoGroup.visible = false;
                    } else { // M·ªü tay
                        treeGroup.visible = false;
                        photoGroup.visible = true;
                    }
                }
            });

            const cameraUtils = new Camera(video, {
                onFrame: async () => { await hands.send({image: video}); },
                width: 640, height: 480
            });
            cameraUtils.start();
        }

        window.addEventListener('resize', () => {
            if(!camera) return;
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });
    </script>
</body>
</html>